import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np

# === Load data ===
file_path = r"C:\Users\OMISTAJA\Downloads\LBN TRAP2 results(SPSS).csv"

df = pd.read_csv(file_path, sep=";")
df = df.loc[:, ~df.columns.str.contains("^Unnamed")]  # drop empty columns

# --- Clean up region names (remove duplicates caused by spaces etc.)
df["region"] = df["region"].str.strip()

group_order = ["CTRL-homecage", "CTRL-OF", "LBN-homecage", "LBN-OF"]

# Convert 'group' to categorical with this order
df_avg["group"] = pd.Categorical(df_avg["group"], categories=group_order, ordered=True)

# === Aggregate: mean per animal, per region ===
df_avg = (
    df.groupby(["id", "group", "sex", "region"], as_index=False)["trapd"]
      .mean()
)


# === Plotting ===
sns.set(style="whitegrid")

regions = df_avg["region"].unique()
fig, axes = plt.subplots(1, len(regions), figsize=(15, 5), sharey=True)

for i, region in enumerate(regions):
    ax = axes[i]
    subdf = df_avg[df_avg["region"] == region]

sns.barplot(
        data=subdf,
        x="group", y="trapd", hue="sex",
        estimator=np.mean,
        errorbar="se",
        capsize=0.1,
        palette="Set2",
        ax=ax,
        order=group_order
    )

    # Stripplot
    strip = sns.stripplot(
        data=subdf,
        x="group", y="trapd", hue="sex",
        dodge=True, jitter=True,
        marker="o", size=5,
        palette="Set2", ax=ax,
        linewidth=0.5, edgecolor="black",
        order=group_order
    )

    # Get the number of unique hues and their offsets
    hue_names = subdf["sex"].unique()
    n_hues = len(hue_names)
    dodge_amount = 0.2  # default Seaborn dodge is ~0.2

    # Map hue to offset
    hue_offset = {hue: -dodge_amount / 2 if i == 0 else dodge_amount / 2 for i, hue in enumerate(hue_names)}

    # Add id labels manually
    for j, row in subdf.iterrows():
        # x-position = group index + dodge offset
        x_pos = group_order.index(row["group"]) + hue_offset[row["sex"]]
        ax.text(
            x=x_pos,
            y=row["trapd"] + 0.02,
            s=str(row["id"]),
            ha="center",
            va="bottom",
            fontsize=8
        )

    ax.set_title(region)
    ax.set_ylabel("TRAP density" if i == 0 else "")
    ax.set_xlabel("")
    ax.tick_params(axis="x", rotation=45)
    ax.get_legend().remove()

# Global legend
handles, labels = axes[0].get_legend_handles_labels()
fig.legend(handles, labels, loc="upper right")

plt.tight_layout()
plt.savefig(r"C:\Users\OMISTAJA\Desktop\Gradu_images\\TRAP_density_with_id.png", dpi=300)
plt.show()
